<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Payment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #fafafa; }
        .progress-bar-bg { background: #e5e7eb; border-radius: 9999px; overflow: hidden; }
        .progress-bar { height: 14px; border-radius: 9999px; transition: width 0.4s ease; }
    </style>
</head>
<body class="p-6">

    <!-- Header -->
    <header class="mb-6">
        <h1 class="text-3xl font-bold text-zinc-800">ðŸ“Š Group Payment Tracker</h1>
        <p class="text-zinc-600">Track member payments, penalties, and monthly progress.</p>
        <div class="mt-3">
            <p>User: <span id="user-id" class="font-mono">Loading...</span></p>
            <button id="auth-btn" class="mt-2 px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700">Sign In</button>
        </div>
    </header>

    <!-- Main Grid -->
    <main class="grid grid-cols-1 lg:col-span-3 lg:grid-cols-3 gap-6">

        <!-- Tracker Table -->
        <section class="lg:col-span-2">
            <h2 class="text-xl font-semibold mb-2">Monthly Progress</h2>
            <div class="overflow-x-auto bg-white shadow rounded">
                <table class="w-full text-sm text-zinc-700">
                    <thead class="bg-zinc-100 text-xs uppercase">
                        <tr>
                            <th class="px-3 py-2 text-left">Name</th>
                            <th class="px-3 py-2">Sept</th>
                            <th class="px-3 py-2">Oct</th>
                            <th class="px-3 py-2">Nov</th>
                            <th class="px-3 py-2">Dec</th>
                        </tr>
                    </thead>
                    <tbody id="tracker-body"></tbody>
                </table>
            </div>
        </section>

        <!-- Summary + Pie -->
        <section>
            <h2 class="text-xl font-semibold mb-2">Summary</h2>
            <div class="bg-white shadow rounded p-4">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-zinc-500">Collected</p>
                        <p id="total-collected" class="text-xl font-bold text-green-600">â‚±0</p>
                    </div>
                    <div>
                        <p class="text-sm text-zinc-500">Outstanding</p>
                        <p id="total-outstanding" class="text-xl font-bold text-red-600">â‚±0</p>
                    </div>
                </div>
                <canvas id="overall-progress-chart" height="200"></canvas>
            </div>
        </section>
    </main>

    <!-- Log Payment Form -->
    <section id="payment-form-section" class="mt-6 hidden">
        <h2 class="text-xl font-semibold mb-2">Log a Payment</h2>
        <div class="bg-white shadow rounded p-4">
            <form id="payment-form" class="space-y-4">
                <div>
                    <label class="block text-sm mb-1">Member</label>
                    <select id="name-select" class="w-full border rounded p-2"></select>
                </div>
                <div>
                    <label class="block text-sm mb-1">Amount</label>
                    <input id="amount-input" type="number" min="0" class="w-full border rounded p-2" placeholder="130" required>
                </div>
                <button type="submit" class="w-full py-2 bg-amber-600 text-white rounded hover:bg-amber-700">Add Payment</button>
            </form>
        </div>
    </section>

    <!-- Payment History -->
    <section id="payment-history-section" class="mt-6 hidden">
        <h2 class="text-xl font-semibold mb-2">Payment History</h2>
        <div class="bg-white shadow rounded overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-zinc-100 text-xs uppercase">
                    <tr>
                        <th class="px-3 py-2 text-left">Name</th>
                        <th class="px-3 py-2 text-left">Amount</th>
                        <th class="px-3 py-2 text-left">Date</th>
                        <th class="px-3 py-2 text-left">Action</th>
                    </tr>
                </thead>
                <tbody id="payment-log-body"></tbody>
            </table>
        </div>
    </section>

    <!-- Modal for messages -->
    <div id="message-modal" class="fixed inset-0 bg-zinc-900 bg-opacity-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full">
            <h3 id="modal-title" class="text-lg font-semibold mb-2">Message</h3>
            <p id="modal-body" class="text-zinc-700 mb-4"></p>
            <button id="modal-close" class="w-full py-2 bg-amber-600 text-white rounded hover:bg-amber-700">OK</button>
        </div>
    </div>

    <!-- Firebase + Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firestore logging
        setLogLevel('debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Firebase initialization
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Auth
        const authBtn = document.getElementById("auth-btn");
        const userIdEl = document.getElementById("user-id");
        let currentUser = null;
        let unsubscribePayments = null;
        
        // Message modal
        const messageModal = document.getElementById("message-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalBody = document.getElementById("modal-body");
        const modalClose = document.getElementById("modal-close");

        modalClose.addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            messageModal.classList.remove('hidden');
        }

        // Handles UI updates based on auth state
        function updateUI(user) {
            currentUser = user;
            if (user && user.uid) { // Check for a valid UID
                userIdEl.textContent = user.uid;
                authBtn.textContent = "Sign Out";
                document.getElementById("payment-form-section").classList.remove("hidden");
                document.getElementById("payment-history-section").classList.remove("hidden");
                setupListeners();
            } else {
                userIdEl.textContent = "Guest";
                authBtn.textContent = "Sign In";
                document.getElementById("payment-form-section").classList.add("hidden");
                document.getElementById("payment-history-section").classList.add("hidden");
                // Clear the table and history when signed out
                document.getElementById("tracker-body").innerHTML = "";
                document.getElementById("payment-log-body").innerHTML = "";
            }
        }

        authBtn.addEventListener("click", async () => {
            if (currentUser && currentUser.uid) {
                await signOut(auth);
            } else {
                await signInWithPopup(auth, new GoogleAuthProvider());
            }
        });
        
        // Listen for auth state changes
        onAuthStateChanged(auth, async user => {
            if (user) {
                updateUI(user);
            } else {
                // If no user, try to sign in with custom token
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error("Custom token sign-in failed. Signing in anonymously...", error);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        // Chart instance
        let chart = null;

        async function setupListeners() {
            // Unsubscribe from previous listener to prevent duplicates
            if (unsubscribePayments) {
                unsubscribePayments();
            }

            // Fetch members and populate select input
            const membersQuery = collection(db, "members");
            const membersSnap = await getDocs(membersQuery);
            const members = membersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            populateMemberSelect(members);

            const paymentsQuery = query(collection(db, "payments")); // Corrected collection name

            // Setup real-time listener for payments
            unsubscribePayments = onSnapshot(paymentsQuery, snap => {
                const payments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTable(members, payments);
                renderHistory(payments);
            });
        }
        
        // Populate member select
        function populateMemberSelect(members) {
            const select = document.getElementById("name-select");
            select.innerHTML = "";
            members.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.Name;
                opt.textContent = m.Name;
                select.appendChild(opt);
            });
        }

        // Render tracker table with monthly progress
        function renderTable(members, payments) {
            const tbody = document.getElementById("tracker-body");
            tbody.innerHTML = "";
            let totalCollected = 0;
            let totalOutstanding = 0;
            const requiredMonthlyPayment = 130;
            const penalty = 20;
            const months = [
                { name: "Sept", index: 8 },
                { name: "Oct", index: 9 },
                { name: "Nov", index: 10 },
                { name: "Dec", index: 11 }
            ];

            const memberData = members.map(m => ({
                name: m.Name,
                payments: payments.filter(p => p.name === m.Name),
                carryOver: 0,
            }));

            memberData.forEach(member => {
                let row = `<tr class="border-b"><td class="px-3 py-2 font-medium">${member.name}</td>`;
                
                months.forEach(month => {
                    const paymentsForMonth = member.payments.filter(p => {
                        const paymentDate = p.timestamp?.toDate() || new Date(p.date);
                        return paymentDate.getMonth() === month.index;
                    });
                    
                    let paidThisMonth = paymentsForMonth.reduce((sum, p) => sum + p.amount, 0);
                    let totalPaidIncludingCarryOver = paidThisMonth + member.carryOver;
                    let progress = Math.min(100, (totalPaidIncludingCarryOver / requiredMonthlyPayment) * 100);
                    let barColor = progress >= 100 ? "bg-green-500" : "bg-red-500";
                    let statusText = "";
                    let outstanding = 0;

                    if (totalPaidIncludingCarryOver >= requiredMonthlyPayment) {
                        statusText = "Paid";
                        member.carryOver = totalPaidIncludingCarryOver - requiredMonthlyPayment;
                        totalCollected += requiredMonthlyPayment;
                    } else {
                        outstanding = requiredMonthlyPayment + penalty;
                        statusText = `Due â‚±${outstanding}`;
                        member.carryOver = 0;
                        totalOutstanding += outstanding;
                        totalCollected += totalPaidIncludingCarryOver;
                    }

                    row += `
                        <td class="px-3 py-2">
                            <div class="progress-bar-bg"><div class="progress-bar ${barColor}" style="width:${progress}%"></div></div>
                            <p class="text-xs text-zinc-500 mt-1">${statusText}</p>
                        </td>`;
                });

                row += "</tr>";
                tbody.innerHTML += row;
            });

            // Update summary + chart
            document.getElementById("total-collected").textContent = "â‚±" + totalCollected;
            document.getElementById("total-outstanding").textContent = "â‚±" + totalOutstanding;

            const ctx = document.getElementById("overall-progress-chart").getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: ["Collected", "Outstanding"],
                    datasets: [{ data: [totalCollected, totalOutstanding], backgroundColor: ["#22c55e", "#ef4444"] }]
                },
                options: { plugins: { legend: { position: "bottom" } } }
            });
        }

        // Render history
        function renderHistory(payments) {
            const tbody = document.getElementById("payment-log-body");
            tbody.innerHTML = "";
            const sortedPayments = payments.sort((a, b) => {
                const dateA = a.timestamp?.toDate() || new Date(a.date);
                const dateB = b.timestamp?.toDate() || new Date(b.date);
                return dateB - dateA;
            });

            sortedPayments.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="px-3 py-2">${p.name}</td>
                    <td class="px-3 py-2">â‚±${p.amount}</td>
                    <td class="px-3 py-2">${(p.timestamp?.toDate() || new Date(p.date)).toLocaleString() || ""}</td>
                    <td class="px-3 py-2">
                        ${currentUser && !currentUser.isAnonymous
                            ? `<button data-id="${p.id}" class="delete-btn text-red-600 hover:underline">Delete</button>`
                            : `<span class="text-zinc-400">Locked</span>`}
                    </td>`;
                tbody.appendChild(tr);
            });

            if (currentUser && !currentUser.isAnonymous) {
                document.querySelectorAll(".delete-btn").forEach(btn => {
                    btn.onclick = async e => {
                        const docId = e.target.dataset.id;
                        try {
                            await deleteDoc(doc(db, "payments", docId)); // Corrected collection name
                        } catch (error) {
                            console.error("Error deleting document:", error);
                        }
                    };
                });
            }
        }

        // Add payment
        document.getElementById("payment-form").addEventListener("submit", async e => {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) {
                showMessage("Sign-in Required", "You must be signed in to add payments.");
                return;
            }
            const name = document.getElementById("name-select").value;
            const amount = parseFloat(document.getElementById("amount-input").value);
            if (!name || isNaN(amount) || amount <= 0) {
                showMessage("Invalid Input", "Please select a member and enter a valid amount.");
                return;
            }
            try {
                await addDoc(collection(db, "payments"), { // Corrected collection name
                    name,
                    amount,
                    timestamp: serverTimestamp(),
                    userId: currentUser.uid
                });
                e.target.reset();
            } catch (error) {
                console.error("Error adding payment:", error);
                showMessage("Error", "Failed to add payment. Please try again.");
            }
        });
    </script>
</body>
</html>
