<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Payment Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #fafafa; }
    .progress-bar-bg { background: #e5e7eb; border-radius: 9999px; overflow: hidden; }
    .progress-bar { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; text-align: center; font-size: 0.75rem; font-weight: 500; }
  </style>
</head>
<body class="antialiased">
  <div class="container mx-auto p-4 max-w-7xl">
    <!-- Header -->
    <header class="mb-6">
      <h1 class="text-3xl font-bold">Group Payment Tracker</h1>
      <p class="text-gray-600">Monitor monthly payments with live updates.</p>
      <div class="mt-3 flex justify-between items-center bg-gray-100 px-4 py-2 rounded">
        <span>You are viewing as <span id="user-status" class="font-bold">Guest</span></span>
        <button id="auth-button" class="bg-gray-200 px-3 py-1 rounded">Sign In</button>
      </div>
    </header>

    <!-- Progress Dashboard -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">Monthly Progress Dashboard</h2>
      <div class="overflow-x-auto bg-white rounded shadow">
        <table class="w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2">Name</th>
              <th class="px-3 py-2">September</th>
              <th class="px-3 py-2">October</th>
              <th class="px-3 py-2">November</th>
              <th class="px-3 py-2">December</th>
            </tr>
          </thead>
          <tbody id="progress-body"></tbody>
        </table>
      </div>
    </section>

    <!-- Summary & Chart -->
    <section class="mb-8">
      <h2 class="text-xl font-semibold mb-2">Collection Summary</h2>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-white rounded shadow p-4 text-center">
          <p class="text-gray-500">Collected</p>
          <p id="summary-collected" class="text-2xl font-bold text-green-600">‚Ç±0</p>
        </div>
        <div class="bg-white rounded shadow p-4 text-center">
          <p class="text-gray-500">Outstanding</p>
          <p id="summary-outstanding" class="text-2xl font-bold text-red-600">‚Ç±0</p>
        </div>
      </div>
      <canvas id="summary-chart" class="bg-white p-4 rounded shadow"></canvas>
    </section>

    <!-- Log Payment (only visible when signed in) -->
    <section id="log-section" class="mb-8 hidden">
      <h2 class="text-xl font-semibold mb-2">Log a New Payment</h2>
      <form id="payment-form" class="bg-white rounded shadow p-4">
        <label class="block mb-2">Name</label>
        <select id="member-select" required class="border rounded p-2 w-full mb-4"></select>
        <label class="block mb-2">Amount Paid (‚Ç±)</label>
        <input type="number" id="amount-input" min="0" required class="border rounded p-2 w-full mb-4">
        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Add Payment</button>
      </form>
    </section>

    <!-- Payment History -->
    <section>
      <h2 class="text-xl font-semibold mb-2">Payment History</h2>
      <div class="overflow-x-auto bg-white rounded shadow">
        <table class="w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2">Name</th>
              <th class="px-3 py-2">Amount</th>
              <th class="px-3 py-2">Date</th>
              <th class="px-3 py-2 crud-only hidden">Action</th>
            </tr>
          </thead>
          <tbody id="history-body"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyClZuFFFxtiwJar_YLrC8-G4ZSC5kSJJdU",
      authDomain: "group-payment-tracker.firebaseapp.com",
      projectId: "group-payment-tracker",
      storageBucket: "group-payment-tracker.appspot.com",
      messagingSenderId: "208078945785",
      appId: "1:208078945785:web:5164201a43e0bd37c8d128"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // üîπ UI Elements
    const authButton = document.getElementById("auth-button");
    const userStatus = document.getElementById("user-status");
    const logSection = document.getElementById("log-section");
    const historyBody = document.getElementById("history-body");
    const progressBody = document.getElementById("progress-body");
    const memberSelect = document.getElementById("member-select");
    const summaryCollected = document.getElementById("summary-collected");
    const summaryOutstanding = document.getElementById("summary-outstanding");

    let chart;

    // üîπ Handle Sign In / Out
    authButton.addEventListener("click", () => {
      if (auth.currentUser) {
        signOut(auth);
      } else {
        signInWithPopup(auth, provider);
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        userStatus.textContent = user.displayName || user.email;
        authButton.textContent = "Sign Out";
        logSection.classList.remove("hidden");
        document.querySelectorAll(".crud-only").forEach(el => el.classList.remove("hidden"));
      } else {
        userStatus.textContent = "Guest";
        authButton.textContent = "Sign In";
        logSection.classList.add("hidden");
        document.querySelectorAll(".crud-only").forEach(el => el.classList.add("hidden"));
      }
      renderDashboard();
    });

    // üîπ Load Members + Payments
    async function renderDashboard() {
      const membersSnap = await getDocs(collection(db, "members"));
      const paymentsSnap = await getDocs(query(collection(db, "payments"), orderBy("timestamp", "asc")));

      let members = [];
      membersSnap.forEach(doc => members.push(doc.data().Name));

      let payments = [];
      paymentsSnap.forEach(doc => payments.push({ id: doc.id, ...doc.data() }));

      renderMembers(members, payments);
      renderHistory(payments);
      renderSummary(members, payments);
    }

    // üîπ Render Members + Progress Bars
    function renderMembers(members, payments) {
      progressBody.innerHTML = "";
      memberSelect.innerHTML = "";

      members.forEach(name => {
        memberSelect.innerHTML += `<option value="${name}">${name}</option>`;

        // compute per month progress
        let monthProgress = [0,0,0,0];
        let balance = 0;
        const months = ["September","October","November","December"];

        payments.filter(p => p.name === name).forEach(p => balance += p.amount);

        for (let i=0;i<4;i++) {
          if (balance >= 130) {
            monthProgress[i] = 100;
            balance -= 130;
          } else if (balance > 0) {
            let percent = (balance / 130) * 100;
            monthProgress[i] = percent;
            balance = 0;
          }
        }

        let row = `<tr>
          <td class="px-3 py-2 font-medium">${name}</td>`;
        monthProgress.forEach(p => {
          row += `<td class="px-3 py-2"><div class="progress-bar-bg"><div class="progress-bar ${p===100 ? 'bg-green-500' : p===0 ? 'bg-red-500' : 'bg-yellow-400'}" style="width:${p}%">${Math.round(p)}%</div></div></td>`;
        });
        row += `</tr>`;
        progressBody.innerHTML += row;
      });
    }

    // üîπ Render Payment History
    function renderHistory(payments) {
      historyBody.innerHTML = "";
      payments.forEach(p => {
        let row = `<tr>
          <td class="px-3 py-2">${p.name}</td>
          <td class="px-3 py-2">‚Ç±${p.amount}</td>
          <td class="px-3 py-2">${p.timestamp?.toDate?.().toLocaleString() || ""}</td>
          <td class="px-3 py-2 crud-only hidden">
            <button class="bg-red-500 text-white px-2 py-1 rounded" data-id="${p.id}">Delete</button>
          </td>
        </tr>`;
        historyBody.innerHTML += row;
      });

      document.querySelectorAll("[data-id]").forEach(btn => {
        btn.addEventListener("click", async () => {
          await deleteDoc(doc(db, "payments", btn.dataset.id));
          renderDashboard();
        });
      });
    }

    // üîπ Render Summary + Chart
    function renderSummary(members, payments) {
      let collected = payments.reduce((sum, p) => sum+p.amount, 0);
      let expected = members.length * 130 * 4;
      let outstanding = expected - collected;

      summaryCollected.textContent = "‚Ç±" + collected;
      summaryOutstanding.textContent = "‚Ç±" + outstanding;

      if (chart) chart.destroy();
      chart = new Chart(document.getElementById("summary-chart"), {
        type: "pie",
        data: {
          labels: ["Collected","Outstanding"],
          datasets: [{ data:[collected, outstanding], backgroundColor:["green","red"] }]
        }
      });
    }

    // üîπ Handle Add Payment
    document.getElementById("payment-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = memberSelect.value;
      const amount = parseFloat(document.getElementById("amount-input").value);
      await addDoc(collection(db,"payments"), { name, amount, timestamp: serverTimestamp() });
      document.getElementById("payment-form").reset();
      renderDashboard();
    });
//PLEASE WORK üôè
    renderDashboard();
  </script>
</body>
</html>
