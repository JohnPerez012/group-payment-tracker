<!DOCTYPE html>
<html lang="en">
<head>  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Payment Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #fafafa;
        }

        .progress-bar-bg {
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            height: 14px;
        }

        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.4s ease, background-color 0.4s ease;
        }
    </style>
</head>
<body class="p-6"> <header class="mb-6">
        <h1 class="text-3xl font-bold text-zinc-800">ðŸ“Š Group Payment Tracker</h1>
        <p class="text-zinc-600">Track member payments, penalties, and monthly progress.</p>
        <div class="mt-3">
            <p>User: <span id="user-id" class="font-mono">Loading...</span></p>
            <button id="auth-btn" class="mt-2 px-4 py-2 bg-amber-600 text-white rounded hover:bg-amber-700">Sign In</button>
        </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">   <section class="lg:col-span-2">
            <h2 class="text-xl font-semibold mb-2">Monthly Progress</h2>
            <div class="overflow-x-auto bg-white shadow rounded">
                <table class="w-full text-sm text-zinc-700">
                    <thead class="bg-zinc-100 text-xs uppercase">
                        <tr>
                            <th class="px-3 py-2">Name</th>
                            <th class="px-3 py-2">Sept</th>
                            <th class="px-3 py-2">Oct</th>
                            <th class="px-3 py-2">Nov</th>
                            <th class="px-3 py-2">Dec</th>
                        </tr>
                    </thead>
                    <tbody id="tracker-body"></tbody>
                </table>
            </div>
        </section> <section>
            <h2 class="text-xl font-semibold mb-2">Summary</h2>
            <div class="bg-white shadow rounded p-4">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-zinc-500">Collected</p>
                        <p id="total-collected" class="text-xl font-bold text-green-600">â‚±0</p>
                    </div>
                    <div>
                        <p class="text-sm text-zinc-500">Outstanding</p>
                        <p id="total-outstanding" class="text-xl font-bold text-red-600">â‚±0</p>
                    </div>
                </div>
                <canvas id="overall-progress-chart" height="200"></canvas>
            </div>
        </section>
    </main> <section id="payment-form-section" class="mt-6 hidden">
        <h2 class="text-xl font-semibold mb-2">Log a Payment</h2>
        <div class="bg-white shadow rounded p-4">
            <form id="payment-form" class="space-y-4">
                <div>
                    <label class="block text-sm mb-1">Member</label>
                    <select id="name-select" class="w-full border rounded p-2"></select>
                </div>
                <div>
                    <label class="block text-sm mb-1">Amount</label>
                    <input id="amount-input" type="number" min="0" class="w-full border rounded p-2" placeholder="130" required>
                </div>
                <button type="submit" class="w-full py-2 bg-amber-600 text-white rounded hover:bg-amber-700">Add Payment</button>
            </form>
        </div> <section id="payment-history-section" class="mt-6 hidden">
        <h2 class="text-xl font-semibold mb-2">Payment History</h2>
        <div class="bg-white shadow rounded overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-zinc-100 text-xs uppercase">
                    <tr>
                        <th class="px-3 py-2">Name</th>
                        <th class="px-3 py-2">Amount</th>
                        <th class="px-3 py-2">Date</th>
                        <th class="px-3 py-2">Action</th>
                    </tr>
                </thead>
                <tbody id="payment-log-body"></tbody>
            </table>
        </div>  </section>  <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyClZuFFFxtiwJar_YLrC8-G4ZSC5kSJJdU",
            authDomain: "group-payment-tracker.firebaseapp.com",
            projectId: "group-payment-tracker",
            storageBucket: "group-payment-tracker.firebasestorage.app",
            messagingSenderId: "208078945785",
            appId: "1:208078945785:web:5164201a43e0bd37c8d128"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);   // Auth
        const authBtn = document.getElementById("auth-btn");
        const userIdEl = document.getElementById("user-id");
        let currentUser = null;
  function updateUI(user) {
            if (user && !user.isAnonymous) {
                currentUser = user;
                userIdEl.textContent = user.email;
                authBtn.textContent = "Sign Out";
                document.getElementById("payment-form-section").classList.remove("hidden");
                document.getElementById("payment-history-section").classList.remove("hidden");
            } else {
                currentUser = null;
                userIdEl.textContent = "Guest";
                authBtn.textContent = "Sign In";
                document.getElementById("payment-form-section").classList.add("hidden");
                document.getElementById("payment-history-section").classList.add("hidden");
            }
        }  authBtn.addEventListener("click", async () => {
            if (currentUser) {
                await signOut(auth);
            } else {
                await signInWithPopup(auth, new GoogleAuthProvider());
            }
        });  onAuthStateChanged(auth, user => {
            if (!user) signInAnonymously(auth);
            updateUI(user);
            if (user) setupListeners();
        });     let chart = null;  // Setup Listeners
        async function setupListeners() {
            const membersSnap = await getDocs(collection(db, "members"));
            const members = membersSnap.docs.map(d => ({
                id: d.id,
                ...d.data()
            }));
            populateMemberSelect(members);
 const paymentsQuery = query(collection(db, "payments"), orderBy("timestamp", "desc"));
            onSnapshot(paymentsQuery, snap => {
                const payments = snap.docs.map(d => ({
                    id: d.id,
                    ...d.data()
                }));
                renderTable(members, payments);
                renderHistory(payments);
            });
        } // Populate member select
        function populateMemberSelect(members) {
            const select = document.getElementById("name-select");
            select.innerHTML = "";
            members.forEach(m => {
                const opt = document.createElement("option");
                opt.value = m.Name;
                opt.textContent = m.Name;
                select.appendChild(opt);
            });
        }   // Render tracker
        function renderTable(members, payments) {
            const tbody = document.getElementById("tracker-body");
            tbody.innerHTML = "";
            let totalCollected = 0;
            let totalOutstanding = 0;
            const requiredAmount = 130;
            const months = ["Sept", "Oct", "Nov", "Dec"];       members.forEach(m => {
                let row = `<tr class="border-b"><td class="px-3 py-2 font-medium">${m.Name}</td>`;
                
                let cumulativePaid = 0;
                let cumulativeRequired = 0;    months.forEach((month, i) => {
                    const monthIndex = new Date(`2025-${month}`).getMonth();
                    const endOfMonth = new Date(2025, monthIndex + 1, 0);       // Add monthly payments to cumulative total
                    payments.filter(p => p.name === m.Name && p.timestamp.toDate() <= endOfMonth)
                            .forEach(p => cumulativePaid += p.amount);           // Add monthly required amount to cumulative total
                    cumulativeRequired += requiredAmount;
    let progress = Math.min(100, (cumulativePaid / cumulativeRequired) * 100);
                    const barColor = progress === 100 ? "bg-green-500" : (progress > 0 ? "bg-orange-400" : "bg-red-500");
                    const progressText = `${Math.round(progress)}%`;  row += `
                        <td class="px-3 py-2">
                            <div class="progress-bar-bg mb-1"><div class="progress-bar ${barColor}" style="width:${progress}%"></div></div>
                            <p class="text-xs font-semibold text-center">${progressText}</p>
                        </td>`;
                    
                    if (i === months.length - 1) {
                         totalCollected += cumulativePaid;
                         totalOutstanding += (cumulativeRequired - cumulativePaid) > 0 ? (cumulativeRequired - cumulativePaid) + (cumulativeRequired - cumulativePaid > 0 ? 20 : 0) : 0;
                    }
                });
                row += "</tr>";
                tbody.innerHTML += row;
            });
            
            // This logic is flawed for multiple members, so we'll recalculate totals here
            totalCollected = 0;
            totalOutstanding = 0;
            members.forEach(m => {
                const paymentsForMember = payments.filter(p => p.name === m.Name);
                const cumulativePaid = paymentsForMember.reduce((sum, p) => sum + p.amount, 0);
                const cumulativeRequired = requiredAmount * months.length;
                totalCollected += cumulativePaid;
                totalOutstanding += (cumulativeRequired - cumulativePaid) > 0 ? (cumulativeRequired - cumulativePaid) + 20 : 0;
            });   // Update summary + chart
            document.getElementById("total-collected").textContent = "â‚±" + totalCollected;
            document.getElementById("total-outstanding").textContent = "â‚±" + totalOutstanding;     const ctx = document.getElementById("overall-progress-chart").getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: ["Collected", "Outstanding"],
                    datasets: [{
                        data: [totalCollected, totalOutstanding],
                        backgroundColor: ["#22c55e", "#ef4444"]
                    }]
                },
                options: {
                    plugins: {
                        legend: {
                            position: "bottom"
                        }
                    }
                }
            });
        }// Render history
        function renderHistory(payments) {
            const tbody = document.getElementById("payment-log-body");
            tbody.innerHTML = "";
            payments.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td class="px-3 py-2">${p.name}</td>
                    <td class="px-3 py-2">â‚±${p.amount}</td>
                    <td class="px-3 py-2">${p.timestamp?.toDate().toLocaleString() || ""}</td>
                    <td class="px-3 py-2">
                        ${currentUser && !currentUser.isAnonymous
                            ? `<button data-id="${p.id}" class="delete-btn text-red-600 hover:underline">Delete</button>`
                            : `<span class="text-zinc-400">Locked</span>`}
                    </td>`;
                tbody.appendChild(tr);
            }); if (currentUser && !currentUser.isAnonymous) {
                document.querySelectorAll(".delete-btn").forEach(btn => {
                    btn.onclick = async e => await deleteDoc(doc(db, "payments", e.target.dataset.id));
                });
            }
        } // Add payment
        document.getElementById("payment-form").addEventListener("submit", async e => {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return alert("Sign in required");
            const name = document.getElementById("name-select").value;
            const amount = parseFloat(document.getElementById("amount-input").value);
            if (!name || isNaN(amount)) return;
            await addDoc(collection(db, "payments"), {
                name,
                amount,
                timestamp: serverTimestamp()
            });
            e.target.reset();
        });</script>
</body>
</html>
